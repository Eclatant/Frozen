# 당신의 게임에 블랙박스가 붙었어요!
후킹하지 않는 실시간 게임 레코더 개발 사례
게임의 녹화부터 보고까지 : 블랙박스 개발기

## 블랙박스
사전 등록된 게임 구동시 플레이 영상을 상시 녹화하는 애플리케이션
영상을 통해 **버그**를 개발자가 직접 확인 가능, **증거**로서의 역할
크래시 발생시 **다잉 메시지**, 게임 플레이 분석

상시 레코딩 기능만으로 보면 좋은게 더 많음
-> 그렇지만 획득한 화면을 가공하여 응용할 수 있는 가능성(키입력, 메모리, CPU 등)

### 데모
보통 트레이에 위치해 있는 윈도우 애플리케이션 (C#)
보고하기 버튼 혹은 단축키를 누르면 JIRA가 뜸

## 다룰 내용
영상과 캡쳐 기술, 사운드 녹화 기술
- GDI, DirectX 9, DXGI, DWM 등

## 사전 지식
### 게임 플레이가 동영상이 되기까지
비디오소스, 오디오소스(제외 가능)가 필요 -> 인코딩/먹싱
유일하게 MP4가 스트리밍도 되고 H.264 크로미움 둘 다 O

### Codec
로우 데이터 압축을 위해 Codec이 필요 -> H.264쓰세요
브라우저 및 HTML 5 호환성이 매우 높고, 하드웨어 가속도 지원, 사실상 업계 표준

### 레코딩을 위한 라이브러리
옛날 건 거르고 지금은 FFmpeg 근데 라이선스랑 종속성이 복잡해 인프라에 쓰긴 어려움
초기엔 video for windows(1997) -> 쓰면쓸수록 단점이 부각돼 제외
현재 Media Foundation -> mp4기본 지원, 멀티스레드 친화적, FFmpeg사용할 일이 없어짐, 종속성 없어서 배포 간단

## 화면 캡쳐 소스 획득하기
### GDI 사용
데스크탑의 Device Context를 획득하여 bitmap생성 -> 진짜 느림

### Direct3D 9 사용
프론트 버퍼를 받아서 클립핑
성능 보장이 힘듬, 창이 가려져 있으면 그대로 녹화되므로 부적합
개발은 쉬움

### 백버퍼 취득
초기에 실제로 진행했으나 다수의 프로젝트 연동 불편
안정성 문제, 디바이스 로스트에 취약

### 윈도우 미디어 9 SDK
화면을 캡쳐해 WMV파일로 출력

### Desktop Duplication API
window8부터 지원함
성능이 가장 우월
그러나 특정 창의 화면이 가려지는 이슈가 있었음

### DirectX 버전마다 Hooking
가장 좋은 방법이긴 함
프랩스, 반디캠 등의 애플리케이션들이 사용하는 방법
그러나 유지보수가 어렵고, 런타임 에러 메시지 박스가 뜨면? 녹화 안됨, 타이틀바까지 녹화안됨

### DWM으로 획득 : 선택
이게 뭐나면 다음 페이지에서

## Desktop Window Manager (DWM)
윈도우 7은 에어로 테마를 작동시켜야함

고려한 이유 : 알트탭을 누르면 활성화된 창들의 썸네일을 실시간 갱신
-> 이 화면은 윈도우가 어딘가에 가지고 있을 것이다 라고 판단
데모 : DWM API를 이용해 게임 화면을 그대로 가져오고 실시간 갱신까지

가능한 이유 : DXGI의 화면 전송이 DWM을 통해서 벌어지기 때문

### 문제와 해결
섬네일은 지원이 되는데 캡쳐기능은 지원이 안됨
갱신은 되는데 레코딩이 안됨
-> dll을 까보니 msdn에도 존재하지 않는 API함수들 발견
-> 정리해둔 곳에서 함수의 프로토타입 획득
-> 획득한 공유 표면 핸들을 사용하여 D3D 텍스쳐 생성 시도
-> 그런데 몇줄의 코드로 게임 화면의 텍스쳐를 순식간에 획득했음
-> 이쯤되니 메시지박스가 캡쳐가 안되도 괜찮다고 타협함

### 괜찮은 수준에 도달
DX7으로 돌아가는 클래식 게임도 레코딩이 됨
유니티 엔진, 언리얼 엔진과도 호환성 체크 완료
완벽한건 아니기에 D3D Hooking과 Desktop Duplication API로 일부 보완을 권장
`DwmGetDxSharedSurface()`을 쓰자

## 오디오 캡쳐
스테레오 믹스를 인위적으로 설정하지 않아도 되는 방법이 있을까?
-> Windows Audio Session API (+Loopback)

## 이제 인코딩/먹싱
비디오 소스는 H.264코덱
오디오 소스는 AAC코덱

## 게임화면 레코더 개발시 고려할 점
게임의 해상도 변경시
다운 스케일링으로 인한 성능 향상
H.264 프로파일에 따른 영상 비율 제한과 영상 크기의 제한
영상이 끝나면 반드시 `Finalize`로 닫아줘야함
용량이 커지면 파일 분리

## JIRA와 통합하기
인앱 브라우저에 그냥 JIRA띄워줌
사실 그냥 띄운건 아니고 내장 크로미움 브라우저(CEF)에 띄우되 자동 로그인 후 이슈를 작성하는 웹페이지로 이동
js와 제이쿼리를 이용해 자연스러운 인앱 리포트 UX획득

## 정리
화면 캡쳐 : `User32.dll!DwmGetDxSharedSurface`
텍스쳐/렌더링 인터페이스 : `DirectX 10/11`
오디오 캡쳐 : `WASAPI Loopback`
인코딩 API : `Media Foundation (mp4/H.264/ACC)`
이슈 리포트 시스템 : `CEF` + `JIRA REST API`